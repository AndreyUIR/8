<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Javascript с Дрейдоном</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: black;
            color: white;
            /* overflow: hidden; */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #001111; 
        }
        ::-webkit-scrollbar-thumb {
            background: #005555; 
            border: 1px solid #00FFFF;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #008888; 
        }

        /* Utilities */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom {
            animation: pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid Background */
        .bg-grid-pattern {
            background-image: linear-gradient(rgba(0,255,255,0.03) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(0,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Scanline */
        .bg-scanline {
            background-image: linear-gradient(transparent 50%, rgba(0,255,255,0.1) 50%);
            background-size: 100% 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative cursor-crosshair">

    <!-- Start Screen Overlay (Fix for Autoplay Policy) -->
    <div id="start-screen" class="fixed inset-0 z-[100] bg-black flex items-center justify-center flex-col gap-8 transition-opacity duration-1000">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-[#002222] via-[#000000] to-[#000000] opacity-50"></div>
        <div class="bg-grid-pattern absolute inset-0 opacity-20"></div>
        
        <div class="relative z-10 flex flex-col items-center gap-6">
            <div class="text-[#00FFFF] font-['Share_Tech_Mono'] text-2xl md:text-5xl uppercase tracking-[0.2em] animate-pulse text-center px-4 drop-shadow-[0_0_10px_rgba(0,255,255,0.5)]">
                Работа системы налажена
            </div>
            <div class="text-[#008888] font-['Share_Tech_Mono'] text-sm md:text-base tracking-widest uppercase mb-4">
            </div>
            <button onclick="initializeSystem()" class="group relative w-full max-w-xs md:max-w-none md:w-auto px-8 md:px-12 py-4 bg-[#001111] border border-[#00FFFF] overflow-hidden transition-all hover:shadow-[0_0_30px_rgba(0,255,255,0.4)] hover:border-[#FFFFFF]">
                <div class="absolute inset-0 bg-[#00FFFF]/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                <span class="relative text-[#00FFFF] font-bold tracking-[0.2em] uppercase text-lg group-hover:text-white transition-colors">Запустить</span>
            </button>
        </div>
    </div>

    <!-- Crash Screen Overlay -->
    <div id="crash-screen" class="fixed inset-0 z-[200] bg-black flex items-center justify-center flex-col gap-8 transition-opacity duration-1000 hidden opacity-0 pointer-events-none">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-[#220000] via-[#000000] to-[#000000] opacity-80"></div>
        <div class="bg-grid-pattern absolute inset-0 opacity-20"></div>
        
        <div class="relative z-10 flex flex-col items-center gap-6">
            <div class="text-[#FF0000] font-['Share_Tech_Mono'] text-2xl md:text-5xl uppercase tracking-[0.2em] animate-pulse text-center px-4 drop-shadow-[0_0_20px_rgba(255,0,0,0.8)]">
                Внешний источник связи не работает
            </div>
            <div class="text-[#880000] font-['Share_Tech_Mono'] text-sm md:text-base tracking-widest uppercase mb-4">
            </div>
        </div>
    </div>

    <!-- Background Ambience -->
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-[#1a1a1a] via-[#000000] to-[#000000] -z-20"></div>
    
    <!-- Tech Background Elements -->
    <div class="absolute inset-0 opacity-20 pointer-events-none -z-10">
        <div class="absolute top-10 left-10 w-32 h-32 border-t-2 border-l-2 border-[#00FFFF] rounded-tl-3xl"></div>
        <div class="absolute bottom-10 right-10 w-32 h-32 border-b-2 border-r-2 border-[#00FFFF] rounded-br-3xl"></div>
    </div>

    <!-- Hidden YouTube Player -->
    <div id="player" class="absolute top-0 left-0 opacity-0 pointer-events-none w-0 h-0"></div>

    <!-- Back Button -->
    <button id="btn-back" onclick="handleBack()" class="hidden absolute top-4 left-4 md:top-8 md:left-8 z-50 flex items-center gap-2 px-4 py-2 bg-[#002222] border border-[#00FFFF] text-[#00FFFF] hover:bg-[#00FFFF] hover:text-black transition-all duration-300 uppercase tracking-wider text-sm font-bold shadow-[0_0_10px_rgba(0,255,255,0.2)]">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        Назад
    </button>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-1 relative z-10 pb-64">
        
        <!-- View: Intro (Empty, just waits) -->
        <div id="view-intro" class="view-section h-full"></div>

        <!-- View: Main Task Menu -->
        <div id="view-mainTask" class="view-section hidden w-full max-w-6xl mx-auto p-4 md:p-8 mt-16 md:mt-20">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="menu-grid">
                <!-- Menu items will be injected here -->
            </div>
            <!-- Mysterious Button Container -->
            <div id="mystery-btn-container" class="flex justify-center mt-12 w-full">
                <button id="mystery-btn" onclick="handleMysteryButton()" class="hidden w-full md:w-auto px-8 py-4 bg-[#001111] border-2 border-[#FF0000] text-[#FF0000] hover:bg-[#FF0000] hover:text-black transition-all duration-500 uppercase tracking-[0.3em] font-bold text-xl shadow-[0_0_20px_rgba(255,0,0,0.4)] animate-pulse">
                    ? ? ?
                </button>
            </div>
        </div>

        <!-- View: Todo List -->
        <div id="view-todoList" class="view-section hidden w-full max-w-4xl mx-auto p-4 md:p-8 mt-16 md:mt-20 text-[#00FFFF]">
            <div class="bg-black/80 border border-[#00FFFF] p-8 shadow-[0_0_20px_rgba(0,255,255,0.2)] relative overflow-hidden">
                <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#00FFFF]"></div>
                <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#00FFFF]"></div>
                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#00FFFF]"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#00FFFF]"></div>

                <h2 class="text-2xl md:text-3xl mb-6 md:mb-8 text-center uppercase tracking-widest border-b border-[#00FFFF]/30 pb-4">Список задач</h2>
                
                <!-- Input Area -->
                <div class="flex flex-col md:flex-row gap-4 mb-8">
                    <input type="text" id="todo-input" class="flex-1 bg-[#001111] border border-[#005555] text-[#00FFFF] p-3 focus:border-[#00FFFF] focus:outline-none focus:shadow-[0_0_10px_rgba(0,255,255,0.3)] transition-all font-mono" placeholder="Новая задача..." onkeypress="if(event.key === 'Enter') addTodo()">
                    <button onclick="addTodo()" class="px-6 py-3 bg-[#002222] border border-[#00FFFF] text-[#00FFFF] hover:bg-[#00FFFF] hover:text-black transition-all duration-300 uppercase tracking-wider font-bold shadow-[0_0_10px_rgba(0,255,255,0.2)] hover:shadow-[0_0_20px_rgba(0,255,255,0.6)]">
                        Добавить
                    </button>
                </div>

                <!-- List -->
                <ul id="todo-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 scrollbar-hide">
                    <!-- Items will be injected here -->
                </ul>
            </div>
        </div>

        <!-- View: Burger Menu -->
        <div id="view-burgerMenu" class="view-section hidden w-full max-w-4xl mx-auto p-4 md:p-8 mt-16 md:mt-20 text-[#00FFFF]">
            <div class="bg-black/80 border border-[#00FFFF] p-8 shadow-[0_0_20px_rgba(0,255,255,0.2)] relative overflow-hidden">
                <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#00FFFF]"></div>
                <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#00FFFF]"></div>
                <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#00FFFF]"></div>
                <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#00FFFF]"></div>

                <h2 class="text-2xl md:text-3xl mb-6 md:mb-8 text-center uppercase tracking-widest border-b border-[#00FFFF]/30 pb-4">Меню Экзо-Питания</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Item 1 -->
                    <div class="bg-[#001111] border border-[#005555] p-4 hover:border-[#00FFFF] transition-colors group cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-[#00FFFF] group-hover:text-white transition-colors">Экзо-Бургер</h3>
                            <span class="text-[#008888]">50 CR</span>
                        </div>
                        <p class="text-sm text-[#00AAAA]">Синтетическое мясо высшего качества, обогащенное протеинами.</p>
                    </div>
                    <!-- Item 2 -->
                    <div class="bg-[#001111] border border-[#005555] p-4 hover:border-[#00FFFF] transition-colors group cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-[#00FFFF] group-hover:text-white transition-colors">Нанитовый Коктейль</h3>
                            <span class="text-[#008888]">35 CR</span>
                        </div>
                        <p class="text-sm text-[#00AAAA]">Жидкая энергия с нано-частицами для мгновенного восстановления.</p>
                    </div>
                    <!-- Item 3 -->
                    <div class="bg-[#001111] border border-[#005555] p-4 hover:border-[#00FFFF] transition-colors group cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-[#00FFFF] group-hover:text-white transition-colors">Плазменная Картошка</h3>
                            <span class="text-[#008888]">25 CR</span>
                        </div>
                        <p class="text-sm text-[#00AAAA]">Обжарена в ионизированном масле до золотистой корочки.</p>
                    </div>
                    <!-- Item 4 -->
                    <div class="bg-[#001111] border border-[#005555] p-4 hover:border-[#00FFFF] transition-colors group cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-[#00FFFF] group-hover:text-white transition-colors">Квантовый Салат</h3>
                            <span class="text-[#008888]">40 CR</span>
                        </div>
                        <p class="text-sm text-[#00AAAA]">Овощи, существующие в суперпозиции вкусов.</p>
                    </div>
                    <!-- Item 5 -->
                    <div class="bg-[#001111] border border-[#005555] p-4 hover:border-[#00FFFF] transition-colors group cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-[#00FFFF] group-hover:text-white transition-colors">Хитиновый Кранч</h3>
                            <span class="text-[#008888]">30 CR</span>
                        </div>
                        <p class="text-sm text-[#00AAAA]">Хрустящие пластины из очищенного хитина пустынных ловцов.</p>
                    </div>
                    <!-- Item 6 -->
                    <div class="bg-[#001111] border border-[#005555] p-4 hover:border-[#00FFFF] transition-colors group cursor-pointer">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-[#00FFFF] group-hover:text-white transition-colors">Пустотный Пудинг</h3>
                            <span class="text-[#008888]">45 CR</span>
                        </div>
                        <p class="text-sm text-[#00AAAA]">Десерт из темной материи. Вкус меняется при каждом укусе.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Dialog Overlay -->
    <div id="draedon-dialog" class="fixed left-0 w-full p-4 md:p-8 flex justify-center items-end z-50 pointer-events-none bottom-12 transition-all duration-700 transform translate-y-20 opacity-0">
        <div class="pointer-events-auto w-full max-w-4xl bg-black/90 border-2 border-[#00FFFF] shadow-[0_0_20px_rgba(0,255,255,0.3)] rounded-lg overflow-hidden relative font-['Share_Tech_Mono']">
            <!-- Header -->
            <div class="h-8 bg-[#003333] border-b border-[#00FFFF] flex items-center px-4 justify-between">
                <div class="flex gap-2">
                    <div class="w-3 h-3 bg-[#00FFFF] rounded-full animate-pulse"></div>
                    <div class="w-3 h-3 bg-[#008888] rounded-full"></div>
                </div>
                <span class="text-[#00FFFF] text-xs tracking-widest uppercase">Экзо-связь налажена</span>
            </div>

            <div class="p-6 md:p-8 flex flex-col md:flex-row gap-6 items-center md:items-start">
                <!-- Portrait -->
                <div class="w-24 h-24 md:w-32 md:h-32 border border-[#00FFFF] bg-[#001111] flex-shrink-0 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-[url('https://avatars.mds.yandex.net/i?id=441e0291f3479ece81ff56cebf892722_l-4877016-images-thumbs&n=13')] bg-center bg-cover bg-no-repeat opacity-80 group-hover:opacity-100 transition-opacity"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                    <div class="bg-scanline absolute inset-0 pointer-events-none"></div>
                </div>

                <div class="flex-1 w-full">
                    <div class="min-h-[80px] mb-6">
                        <p class="text-[#E0FFFF] text-lg md:text-xl leading-relaxed tracking-wide drop-shadow-[0_0_5px_rgba(0,255,255,0.5)]">
                            <span id="dialog-text"></span><span class="animate-pulse inline-block w-2 h-5 bg-[#00FFFF] ml-1 align-middle"></span>
                        </p>
                    </div>

                    <div id="dialog-buttons" class="flex flex-col sm:flex-row gap-4 justify-end opacity-0 transition-opacity duration-500">
                        <!-- Buttons injected via JS -->
                    </div>
                </div>
            </div>
            
            <!-- Grid Effect -->
            <div class="bg-grid-pattern absolute inset-0 pointer-events-none -z-10"></div>
        </div>
    </div>

    <script>
        // --- State & Config ---
        const MUSIC_DEFAULT = 'hd57h5QS6ag';

        let currentView = 'intro';
        let typingInterval = null;
        let dialogStep = 0;
        let dialogCloseTimeout = null;
        let visitedTodo = false;
        let visitedBurger = false;
        let mysteryStep = 0;
        let shouldPlayMusic = false; // Flag for music playback

        const menuOptions = ["Список задач", "Бургер-меню"];
        const viewMap = {
            "Список задач": "todoList",
            "Бургер-меню": "burgerMenu"
        };

        // Todo List State
        let todos = [
            { id: 1, text: "Проснуться", completed: false },
            { id: 2, text: "Наблюдать за бескрайним космосом", completed: false },
            { id: 3, text: "Заняться настройкой экзо-механизмов", completed: false }
        ];

        // --- Initialization ---
        window.onload = function() {
            initMenu();
        };

        function initializeSystem() {
            const startScreen = document.getElementById('start-screen');
            startScreen.classList.add('opacity-0', 'pointer-events-none');
            
            // Set flag to play music when ready
            shouldPlayMusic = true;

            if (player && typeof player.playVideo === 'function') {
                player.playVideo();
                player.setVolume(50);
            }
            
            dialogStep = 0;
            setTimeout(() => {
                updateIntroDialog();
            }, 2000);
        }

        function updateIntroDialog() {
            if (dialogStep === 0) {
                showDialog("...", true);
            } else if (dialogStep === 1) {
                showDialog("Это опять ты? Что тебе нужно? Неужели прошлого раза тебе не хватило?", true);
            } else if (dialogStep === 2) {
                showDialog("Ну что-ж. Раз ты снова здесь, значит тебе опять нужна помощь. Выбирай.", true);
            }
        }

        function nextDialog() {
            dialogStep++;
            updateIntroDialog();
        }

        function initMenu() {
            const container = document.getElementById('menu-grid');
            menuOptions.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "group relative p-4 md:p-6 bg-black/80 border border-[#00FFFF]/30 hover:border-[#00FFFF] transition-all duration-300 text-left overflow-hidden fade-in";
                btn.style.animationDelay = `${index * 0.1}s`;
                btn.onclick = () => handleOptionSelect(opt);
                btn.innerHTML = `
                    <div class="absolute inset-0 bg-[#00FFFF]/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-[#00FFFF]"></div>
                    <div class="absolute top-0 right-0 w-2 h-2 border-t border-r border-[#00FFFF]"></div>
                    <div class="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-[#00FFFF]"></div>
                    <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-[#00FFFF]"></div>
                    <h3 class="text-[#00FFFF] font-['Share_Tech_Mono'] text-xl mb-2 group-hover:text-white transition-colors">${opt}</h3>
                    <div class="h-1 w-12 bg-[#005555] group-hover:w-full group-hover:bg-[#00FFFF] transition-all duration-500"></div>
                `;
                container.appendChild(btn);
            });
        }

        // --- Navigation ---
        function setView(viewId) {
            // Track visits
            if (viewId === 'todoList') visitedTodo = true;
            if (viewId === 'burgerMenu') visitedBurger = true;

            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // Show target view
            const target = document.getElementById(`view-${viewId}`);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
            }
            
            currentView = viewId;
            
            // Handle Back Button
            const btnBack = document.getElementById('btn-back');
            if (viewId !== 'intro') {
                btnBack.classList.remove('hidden');
            } else {
                btnBack.classList.add('hidden');
            }

            // Init specific views
            if (viewId === 'todoList') {
                renderTodos();
            }

            // Handle Mystery Button Visibility
            const mysteryBtn = document.getElementById('mystery-btn');
            if (mysteryBtn) {
                mysteryBtn.classList.add('hidden'); // Always hide initially when switching views
            }

            // Update Dialog
            updateDialogForView(viewId);
        }

        function handleBack() {
            const isTaskView = Object.values(viewMap).includes(currentView);
            if (isTaskView) {
                setView('mainTask');
            } else {
                setView('intro');
                dialogStep = 2;
                updateIntroDialog();
            }
        }

        function handleOptionSelect(option) {
            const targetView = viewMap[option];
            if (targetView) {
                setView(targetView);
            }
        }

        function handleMainTask() {
            setView('mainTask');
        }

        function changeMusic(videoId) {
            if (player && player.loadVideoById) {
                player.loadVideoById({
                    videoId: videoId,
                    startSeconds: 0
                });
                player.setLoop(true);
            }
        }

        // --- Todo List Logic ---
        function renderTodos() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            
            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-4 border ${todo.completed ? 'border-[#005555] bg-[#001111]/50' : 'border-[#00FFFF] bg-[#001111]'} transition-all duration-300 group`;
                
                li.innerHTML = `
                    <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="toggleTodo(${todo.id})">
                        <div class="w-6 h-6 border ${todo.completed ? 'border-[#005555] bg-[#005555]' : 'border-[#00FFFF]'} flex items-center justify-center transition-colors">
                            ${todo.completed ? '<svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                        </div>
                        <span class="${todo.completed ? 'text-[#005555] line-through' : 'text-[#00FFFF]'} text-lg transition-colors font-mono">${todo.text}</span>
                    </div>
                    <button onclick="deleteTodo(${todo.id})" class="text-[#005555] hover:text-[#FF0000] transition-colors p-2 opacity-0 group-hover:opacity-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                list.appendChild(li);
            });
        }

        function addTodo() {
            const input = document.getElementById('todo-input');
            const text = input.value.trim();
            if (text) {
                todos.push({
                    id: Date.now(),
                    text: text,
                    completed: false
                });
                input.value = '';
                renderTodos();
            }
        }

        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                renderTodos();
            }
        }

        function deleteTodo(id) {
            todos = todos.filter(t => t.id !== id);
            renderTodos();
        }

        // --- Mystery Logic ---
        function handleMysteryButton() {
            currentView = 'mysterySequence';
            mysteryStep = 0;
            updateMysteryDialog();
        }

        function updateMysteryDialog() {
            const dialog = document.getElementById('draedon-dialog');
            dialog.classList.remove('opacity-0', 'translate-y-20');
            const dialogContent = dialog.firstElementChild;
            dialogContent.classList.add('pointer-events-auto');
            dialogContent.classList.remove('pointer-events-none');
            
            switch(mysteryStep) {
                case 0:
                    showDialog("Всё же, что нужно этому человеку? Зачем он связался со мной?", true);
                    break;
                case 1:
                    showDialog("Данные, что он предоставляет весьма интересны.", true);
                    break;
                case 2:
                    showDialog("Нужно придумать как извлечь из них пользу.", true);
                    break;
                case 3:
                    showDialog("Кажется, я придумал, только для этого необходимо немного усовершенствовать мои творения.", false, 3000, showCrashScreen);
                    break;
            }
        }

        function nextMysteryDialog() {
            mysteryStep++;
            updateMysteryDialog();
        }

        function showCrashScreen() {
            const crashScreen = document.getElementById('crash-screen');
            const mainContent = document.getElementById('main-content');
            const dialog = document.getElementById('draedon-dialog');
            
            mainContent.classList.add('hidden');
            dialog.classList.add('hidden');
            crashScreen.classList.remove('hidden');
            crashScreen.classList.remove('opacity-0', 'pointer-events-none');
        }

        // --- Dialog Logic ---
        function showDialog(message, showButtons = false, autoCloseDelay = 0, onAutoClose = null) {
            const dialog = document.getElementById('draedon-dialog');
            const textEl = document.getElementById('dialog-text');
            const buttonsEl = document.getElementById('dialog-buttons');
            
            // Clear auto-close timeout if exists
            if (dialogCloseTimeout) {
                clearTimeout(dialogCloseTimeout);
                dialogCloseTimeout = null;
            }

            // Ensure interaction
            const dialogContent = dialog.firstElementChild;
            dialogContent.classList.add('pointer-events-auto');
            dialogContent.classList.remove('pointer-events-none');

            // Reset
            textEl.textContent = '';
            buttonsEl.innerHTML = '';
            buttonsEl.classList.add('opacity-0');
            
            // Show container
            dialog.classList.remove('opacity-0', 'translate-y-20');
            
            // Typing effect
            if (typingInterval) clearInterval(typingInterval);
            let i = 0;
            typingInterval = setInterval(() => {
                if (i < message.length) {
                    textEl.textContent += message.charAt(i);
                    i++;
                } else {
                    clearInterval(typingInterval);
                    // Show buttons if needed
                    if (showButtons) {
                        renderButtons();
                        buttonsEl.classList.remove('opacity-0');
                    }
                    // Auto close if requested
                    if (autoCloseDelay > 0) {
                        dialogCloseTimeout = setTimeout(() => {
                            hideDialog();
                            if (onAutoClose) onAutoClose();
                        }, autoCloseDelay);
                    }
                }
            }, 50);
        }

        function hideDialog() {
            const dialog = document.getElementById('draedon-dialog');
            dialog.classList.add('opacity-0', 'translate-y-20');
            const dialogContent = dialog.firstElementChild;
            dialogContent.classList.remove('pointer-events-auto');
            dialogContent.classList.add('pointer-events-none');
        }

        function renderButtons() {
            const container = document.getElementById('dialog-buttons');
            container.innerHTML = '';
            
            const btnClass = "w-full sm:w-auto px-6 py-3 bg-[#002222] border border-[#00FFFF] text-[#00FFFF] hover:bg-[#00FFFF] hover:text-black transition-all duration-300 uppercase tracking-wider text-sm font-bold shadow-[0_0_10px_rgba(0,255,255,0.2)] hover:shadow-[0_0_20px_rgba(0,255,255,0.6)]";

            if (currentView === 'intro') {
                if (dialogStep < 2) {
                     container.innerHTML = `
                        <button onclick="nextDialog()" class="${btnClass}">Далее</button>
                    `;
                } else {
                     container.innerHTML = `
                        <button onclick="handleMainTask()" class="${btnClass}">Основное задание</button>
                    `;
                }
            } else if (currentView === 'mysterySequence') {
                 if (mysteryStep < 3) {
                     container.innerHTML = `
                        <button onclick="nextMysteryDialog()" class="${btnClass}">Далее</button>
                    `;
                 }
            }
        }

        function updateDialogForView(viewId) {
            const dialog = document.getElementById('draedon-dialog');
            
            // Adjust position based on view
            if (viewId === 'intro') {
                dialog.classList.remove('bottom-0');
                dialog.classList.add('bottom-12');
            } else {
                dialog.classList.remove('bottom-12');
                dialog.classList.add('bottom-0');
            }

            // Messages
            switch(viewId) {
                case 'mainTask':
                    if (visitedTodo && visitedBurger) {
                        showDialog("Значит, сегодня у нас DOM? Твоя натура меня удивляет, поскольку я не могу ее понять. Ни один человек не пытался связаться со мной за многие тысячелетия и мой первый контакт выглядит именно так? Это весьма занимательно.", false, 3000, () => {
                            const mysteryBtn = document.getElementById('mystery-btn');
                            if (mysteryBtn) {
                                mysteryBtn.classList.remove('hidden');
                                mysteryBtn.classList.add('fade-in');
                            }
                        });
                    } else {
                        showDialog("Значит, сегодня у нас DOM? Твоя натура меня удивляет, поскольку я не могу ее понять. Ни один человек не пытался связаться со мной за многие тысячелетия и мой первый контакт выглядит именно так? Это весьма занимательно.");
                    }
                    break;
                case 'todoList':
                    showDialog("Список задач. Структурирование хаоса — первый шаг к эффективности.", false, 3000);
                    break;
                case 'burgerMenu':
                    showDialog("Меню питания персонала. Синтезированная органика для поддержания биологических функций.", false, 3000);
                    break;
            }
        }

        // --- YouTube API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '0',
                width: '0',
                videoId: 'hd57h5QS6ag',
                playerVars: {
                    'autoplay': 0, // Disable autoplay to handle it manually
                    'loop': 1,
                    'playlist': 'hd57h5QS6ag',
                    'controls': 0,
                    'showinfo': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }
        function onPlayerReady(event) {
            event.target.setVolume(50);
            if (shouldPlayMusic) {
                event.target.playVideo();
            }
        }
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                player.playVideo();
            }
        }
        function onPlayerError(event) {
            console.error("YouTube Player Error:", event.data);
        }
    </script>
</body>
</html>
